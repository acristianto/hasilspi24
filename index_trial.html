<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Indeks SPI 2024</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    .angka-indeks { font-size: 1.5rem; font-weight: bold; }
    .angka-agregat { font-size: 2rem; font-weight: bold; }
    .hijau { color: green !important; }
    .kuning { color: orange !important; }
    .merah { color: red !important; }
    .top-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 15px 0;
    }
    .top-buttons a {
      padding: 10px 25px;
      font-weight: 700;
      font-size: 1.1rem;
      text-decoration: none;
      color: white;
      border-radius: 30px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s ease;
      user-select: none;
    }
    .top-buttons a.response-rate-btn {
      background: linear-gradient(45deg, #ff6a00, #ee0979);
    }
    .top-buttons a.indeks-btn {
      background: linear-gradient(45deg, #2193b0, #6dd5ed);
    }
    .top-buttons a:hover {
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
      transform: translateY(-3px);
    }
    .top-buttons a:active {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body style="background-color:white">

<!-- Tombol Modern (tidak membuka tab baru) -->
<div class="container">
  <div class="top-buttons">
    <a href="https://timotiushps.github.io/dashboardresponratespi24/" class="response-rate-btn">Response Rate</a>
    <a href="https://timotiushps.github.io/hasilspi24/" class="indeks-btn">Indeks</a>
  </div>
</div>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <img src="https://elhkpn.kpk.go.id/portal-assets/img/image2.jpeg" style="height:50px;">
    <h3 class="text-center flex-grow-1">Dashboard Indeks Hasil SPI 2024</h3>
    <img src="https://spi.kpk.go.id/img/logo-spi.d5368d4c.png" style="height:50px;">
  </div>

  <div class="mb-3">
    <label for="instansiInput" class="form-label">Nama Instansi:</label>
    <input class="form-control" list="instansiList" id="instansiInput" placeholder="Ketik nama instansi...">
    <datalist id="instansiList"></datalist>
  </div>

  <div class="mb-4">
    <label for="yearSelect" class="form-label">Pilih Tahun:</label>
    <select id="yearSelect" class="form-select">
      <option value="24">2024</option>
      <option value="23">2023</option>
      <option value="22">2022</option>
      <option value="21">2021</option>
    </select>
  </div>

  <div id="summaryBox" class="text-center mb-4"></div>

  <div class="row mb-4">
    <div class="col-md-6"><h6 class="text-center">Indeks Agregat (Sebelum Faktor Koreksi)</h6><canvas id="radarChart" width="400" height="400"></canvas></div>
    <div class="col-md-6"><h6 class="text-center">Faktor Koreksi</h6><canvas id="barChart"></canvas></div>
  </div>

  <div class="row mb-4">
    <div class="col-12"><h6 class="text-center">Tren Indeks (2021–2024)</h6><canvas id="lineChartIndeks"></canvas></div>
    <div class="col-12"><h6 class="text-center">Tren Faktor Koreksi (2021–2024)</h6><canvas id="lineChartFaktor"></canvas></div>
  </div>
</div>

<div class="container mt-5 mb-4">
  <h5 class="text-center mb-3">Detail Komponen Indeks</h5>
  <div class="d-flex justify-content-center mb-3">
    <button class="btn btn-outline-primary mx-1" id="btnInternal" type="button">Internal</button>
    <button class="btn btn-outline-success mx-1" id="btnEksternal" type="button">Eksternal</button>
    <button class="btn btn-outline-warning mx-1" id="btnEksper" type="button">Eksper</button>
  </div>
  <div class="row mb-4">
    <div class="col-md-6 offset-md-3">
      <canvas id="radarKomponenChart" width="350" height="350"></canvas>
    </div>
  </div>
  <div id="tabelDetailKomponen"></div>
  <div id="unitKerjaSection"></div>
</div>

<script>
let rawData = [], radarChart, barChart, lineChartIndeks, lineChartFaktor;
let dataInternal = [], dataEksternal = [], dataEksper = [];
let dataUnitKerjaInternal = [], dataUnitKerjaEksternal = [], dataUnitKerjaEksper = [];
let kelompokAktif = "Internal";
let radarKomponenChart = null;

function getColorClass(value) {
  if (value === undefined || value === null || value === "" || isNaN(value)) return "";
  value = parseFloat(value);
  if (value < 73) return 'merah';
  if (value < 78) return 'kuning';
  return 'hijau';
}

function getColor(value) {
  if (value >= 78) return 'hijau';
  if (value >= 73) return 'kuning';
  return 'merah';
}

function updateDashboard() {
  const instansi = document.getElementById("instansiInput").value;
  const year = document.getElementById("yearSelect").value;
  const filtered = rawData.filter(d => d["data.instansi"] === instansi);

  const getVal = name => {
    const entry = filtered.find(d => d["Index_name"] === name);
    return entry ? parseFloat(entry["Value" + year]) : null;
  };

  const getValsOverYears = name => [21, 22, 23, 24].map(y => {
    const entry = rawData.find(d => d["data.instansi"] === instansi && d["Index_name"] === name);
    return entry && !isNaN(parseFloat(entry["Value" + y])) ? parseFloat(entry["Value" + y]) : 0;
  });

  const nilai = {
    agregat: getVal("Agregat"),
    internal: getVal("Internal"),
    eksternal: getVal("Eksternal"),
    eksper: getVal("Eksper"),
    faktor: getVal("Faktor Koreksi (weighted)"),
    prevalensi: getVal("Prevalensi Korupsi"),
    integritas_spi: getVal("Integritas Pelaksanaan SPI")
  };

  document.getElementById("summaryBox").innerHTML = `
    <div class="d-flex justify-content-center align-items-end flex-wrap gap-3">
      <div class="text-center"><div class="angka-agregat ${getColor(nilai.agregat)}">${nilai.agregat ?? "-"}</div><div class="small text-muted">(Agregat)</div></div>
      <div class="fs-4">=</div>
      <div class="text-center"><div class="angka-indeks ${getColor(nilai.internal)}">${nilai.internal ?? "-"}</div><div class="small text-muted">(Internal)</div></div>
      <div class="fs-4">+</div>
      <div class="text-center"><div class="angka-indeks ${getColor(nilai.eksternal)}">${nilai.eksternal ?? "-"}</div><div class="small text-muted">(Eksternal)</div></div>
      <div class="fs-4">+</div>
      <div class="text-center"><div class="angka-indeks ${getColor(nilai.eksper)}">${nilai.eksper ?? "-"}</div><div class="small text-muted">(Eksper)</div></div>
      <div class="fs-4">-</div>
      <div class="text-center"><div class="angka-indeks ${getColor(nilai.faktor)}">${nilai.faktor ?? "-"}</div><div class="small text-muted">(Faktor Koreksi)</div></div>
    </div>`;

  if (radarChart) radarChart.destroy();
  radarChart = new Chart(document.getElementById("radarChart"), {
    type: "radar",
    data: {
      labels: ["Internal", "Eksternal", "Eksper"],
      datasets: [{
        label: "Agregat",
        data: [nilai.internal, nilai.eksternal, nilai.eksper],
        backgroundColor: "rgba(0, 150, 0, 0.2)",
        borderColor: "#333"
      }]
    },
    options: {
      responsive: true,
      legend: { display: true },
      scale: { ticks: { beginAtZero: true, max: 100 } }
    }
  });

  if (barChart) barChart.destroy();
  barChart = new Chart(document.getElementById("barChart"), {
    type: "bar",
    data: {
      labels: ["Faktor Koreksi"],
      datasets: [
        { label: "Prevalensi Korupsi", data: [nilai.prevalensi], backgroundColor: "#f66" },
        { label: "Integritas SPI", data: [nilai.integritas_spi], backgroundColor: "#69f" }
      ]
    },
    options: {
      responsive: true,
      legend: { display: false },
      scales: {
        xAxes: [{ stacked: true, display: false }],
        yAxes: [{ stacked: true, display: false, ticks: { beginAtZero: true, max: 20 } }]
      }
    }
  });

  if (lineChartIndeks) lineChartIndeks.destroy();
  lineChartIndeks = new Chart(document.getElementById("lineChartIndeks"), {
    plugins: [Chart.plugins.getAll().find(p => p.id === "datalabels")],
    type: "line",
    data: {
      labels: ["2021", "2022", "2023", "2024"],
      datasets: [
        { label: "Agregat", data: getValsOverYears("Agregat"), borderColor: "#000", fill: false },
        { label: "Internal", data: getValsOverYears("Internal"), borderColor: "#28a745", fill: false },
        { label: "Eksternal", data: getValsOverYears("Eksternal"), borderColor: "#ffc107", fill: false },
        { label: "Eksper", data: getValsOverYears("Eksper"), borderColor: "#dc3545", fill: false }
      ]
    },
    options: {
      responsive: true,
      legend: { display: false },
      plugins: {
        datalabels: {
          anchor: 'end',
          align: 'top',
          font: { weight: 'bold' },
          formatter: v => v.toFixed(1)
        }
      },
      scales: {
        xAxes: [{ display: true }],
        yAxes: [{ display: true, ticks: { min: 40, max: 100 } }]
      }
    }
  });

  if (lineChartFaktor) lineChartFaktor.destroy();
  renderFaktorKoreksiLineChart(filtered);
}

fetch("https://raw.githubusercontent.com/timotiushps/hasilspi24/main/agregat_tracking_agregat.csv")
  .then(res => res.text())
  .then(csv => {
    Papa.parse(csv, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        rawData = results.data;
        const instansis = [...new Set(rawData.map(r => r["data.instansi"]))];
        const list = document.getElementById("instansiList");
        instansis.forEach(i => {
          const opt = document.createElement("option");
          opt.value = i;
          list.appendChild(opt);
        });
        document.getElementById("instansiInput").value = "Seluruh K/L/PD Peserta SPI 2024";
        updateDashboard();
      }
    });
  });

document.getElementById("instansiInput").addEventListener("change", updateDashboard);
document.getElementById("yearSelect").addEventListener("change", updateDashboard);

function renderFaktorKoreksiLineChart(filtered) {
  const found1 = filtered.find(d => d["Index_name"] === "Prevalensi Korupsi");
  const found2 = filtered.find(d => d["Index_name"] === "Integritas Pelaksanaan SPI");
  const dataset = [
    {
      label: "Prevalensi Korupsi",
      data: [21,22,23,24].map(y => parseFloat(found1["Value" + y]) || 0),
      borderColor: "#f87979",
      fill: false,
      tension: 0.3
    },
    {
      label: "Integritas Pelaksanaan SPI",
      data: [21,22,23,24].map(y => parseFloat(found2["Value" + y]) || 0),
      borderColor: "#36a2eb",
      fill: false,
      tension: 0.3
    }
  ];
  const ctx = document.getElementById("lineChartFaktor").getContext("2d");
  if (window.lineChartFaktor && typeof window.lineChartFaktor.destroy === "function") window.lineChartFaktor.destroy();
  window.lineChartFaktor = new Chart(ctx, {
    type: "line",
    data: {
      labels: ["2021", "2022", "2023", "2024"],
      datasets: dataset
    },
    options: {
      responsive: true,
      plugins: {
        tooltip: { mode: 'index', intersect: false },
        datalabels: {
          anchor: 'end',
          align: 'top',
          font: { size: 10, weight: 'bold' },
          formatter: v => v.toFixed(1)
        }
      },
      scales: {
        y: { beginAtZero: true, max: 20 }
      }
    },
    plugins: [ChartDataLabels]
  });
}

async function loadAllKomponenData() {
  const urls = {
    internal: "https://raw.githubusercontent.com/timotiushps/hasilspi24/main/agregat_tracking_internal.csv",
    eksternal: "https://raw.githubusercontent.com/timotiushps/hasilspi24/main/agregat_tracking_eksternal.csv",
    eksper: "https://raw.githubusercontent.com/timotiushps/hasilspi24/main/agregat_tracking_eksper.csv"
  };
  const load = url => fetch(url).then(r => r.text()).then(txt => Papa.parse(txt, { header: true, skipEmptyLines: true }).data);
  [dataInternal, dataEksternal, dataEksper] = await Promise.all([
    load(urls.internal), load(urls.eksternal), load(urls.eksper)
  ]);
  [dataUnitKerjaInternal, dataUnitKerjaEksternal, dataUnitKerjaEksper] = await Promise.all([
    fetch('https://raw.githubusercontent.com/timotiushps/hasilspi24/main/internal_cleaned.csv').then(r=>r.text()).then(txt => Papa.parse(txt, {header:true, skipEmptyLines:true}).data),
    fetch('https://raw.githubusercontent.com/timotiushps/hasilspi24/main/eksternal_cleaned.csv').then(r=>r.text()).then(txt => Papa.parse(txt, {header:true, skipEmptyLines:true}).data),
    fetch('https://raw.githubusercontent.com/timotiushps/hasilspi24/main/eksper_cleaned.csv').then(r=>r.text()).then(txt => Papa.parse(txt, {header:true, skipEmptyLines:true}).data)
  ]);
}

function getKomponenData(kelompok, instansi) {
  let sumber = [];
  if (kelompok === "Internal") sumber = dataInternal;
  if (kelompok === "Eksternal") sumber = dataEksternal;
  if (kelompok === "Eksper") sumber = dataEksper;
  const isKomponen = s => !["Internal", "Eksternal", "Eksper"].includes(s);
  return sumber.filter(d => d["data.instansi"] === instansi && isKomponen(d["Index_name"]));
}

function tampilkanTabelRadarKomponen() {
  const instansi = document.getElementById("instansiInput").value;
  const tahun = document.getElementById("yearSelect").value;
  const komponen = getKomponenData(kelompokAktif, instansi);

  // Tabel dengan judul kolom baru dan value berwarna
  const html = `
    <table class="table table-sm table-bordered">
      <thead class="table-light">
        <tr>
          <th>Dimensi</th>
          <th>2021</th>
          <th>2022</th>
          <th>2023</th>
          <th>2024</th>
        </tr>
      </thead>
      <tbody>
        ${komponen.map(r => `
          <tr>
            <td>${r["Index_name"]}</td>
            <td class="${getColorClass(r["Value21"])}">${r["Value21"] ?? "-"}</td>
            <td class="${getColorClass(r["Value22"])}">${r["Value22"] ?? "-"}</td>
            <td class="${getColorClass(r["Value23"])}">${r["Value23"] ?? "-"}</td>
            <td class="${getColorClass(r["Value24"])}">${r["Value24"] ?? "-"}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  document.getElementById("tabelDetailKomponen").innerHTML = html;

  // Radar (multi-year overlay)
  if (kelompokAktif === "Eksper") {
    document.getElementById("radarKomponenChart").style.display = "none";
  } else {
    document.getElementById("radarKomponenChart").style.display = "";
    const labels = komponen.map(r => r["Index_name"]);
    const yearLabels = ["21", "22", "23", "24"];
    const yearNames = ["2021", "2022", "2023", "2024"];
    const colors = [
      "rgba(0,123,255,0.45)",
      "rgba(40,167,69,0.35)",
      "rgba(255,193,7,0.30)",
      "rgba(220,53,69,0.30)"
    ];
    const borderColors = [
      "#007bff", "#28a745", "#ffc107", "#dc3545"
    ];
    const datasets = yearLabels.map((y, i) => ({
      label: yearNames[i],
      data: komponen.map(r => parseFloat(r["Value" + y]) || 0),
      backgroundColor: colors[i],
      borderColor: borderColors[i],
      pointBackgroundColor: borderColors[i],
      pointBorderColor: "#fff",
      fill: true
    }));
    if (radarKomponenChart) radarKomponenChart.destroy();
    radarKomponenChart = new Chart(document.getElementById("radarKomponenChart"), {
      type: "radar",
      data: { labels: labels, datasets: datasets },
      options: {
        responsive: true,
        legend: { display: true, position: 'right' },
        scale: { 
          ticks: { beginAtZero: false, min: 40, max: 100 }
        },
        tooltips: {
          enabled: true,
          callbacks: {
            label: function(tooltipItem, data) {
              const label = data.labels[tooltipItem.index];
              const value = tooltipItem.yLabel;
              const tahun = data.datasets[tooltipItem.datasetIndex].label;
              return label + " (" + tahun + "): " + value;
            }
          }
        },
        plugins: {
          datalabels: {
            display: true,
            font: { size: 7 }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }
  tampilkanUnitKerjaSection();
}

// Pilihan Unit Kerja dan Tabel Value24
function tampilkanUnitKerjaSection() {
  const instansi = document.getElementById("instansiInput").value;
  let dataset = [];
  let urutan = [];

  if (kelompokAktif === "Internal") {
    dataset = dataUnitKerjaInternal;
    urutan = [
      "Internal", "Integritas Dalam Pelaksanaan Tugas", "Pengelolaan Anggaran",
      "Pengelolaan PBJ", "Pengelolaan SDM", "Perdagangan Pengaruh (Trading in Influence)",
      "Sosialisasi Antikorupsi", "Transparansi"
    ];
  }
  else if (kelompokAktif === "Eksternal") {
    dataset = dataUnitKerjaEksternal;
    urutan = [
      "Eksternal", "Integritas Pegawai", "Transparansi dan Keadilan Layanan", "Upaya Pencegahan Korupsi"
    ];
  }
  else if (kelompokAktif === "Eksper") {
    dataset = dataUnitKerjaEksper;
    urutan = ["Eksper", "Integritas Instansi"];
  }

  if (instansi === "Seluruh K/L/PD Peserta SPI 2024") {
    document.getElementById("unitKerjaSection").innerHTML = "";
    return;
  }

  const units = dataset.filter(
    d => d["data.instansi"] === instansi
  );

  if (units.length === 0) {
    document.getElementById("unitKerjaSection").innerHTML = "";
    return;
  }

  const uniqueUnitNames = [...new Set(units.map(u => u["name"]))].filter(Boolean);

  let selectHtml = `
    <div class="mt-4">
      <label for="unitKerjaSelect" class="form-label">Pilih Unit Kerja:</label>
      <select id="unitKerjaSelect" class="form-select mb-2">
        <option value="">-- Pilih Unit Kerja --</option>
        ${uniqueUnitNames.map(u => `<option value="${u}">${u}</option>`).join("")}
      </select>
      <div id="tabelUnitKerja"></div>
    </div>
  `;
  document.getElementById("unitKerjaSection").innerHTML = selectHtml;

  document.getElementById("unitKerjaSelect").onchange = function() {
    const selectedName = this.value;
    if (!selectedName) {
      document.getElementById("tabelUnitKerja").innerHTML = "";
      return;
    }
    const dataPerUnit = units.filter(u => u["name"] === selectedName);
    let html = `
      <table class="table table-sm table-bordered mt-2">
        <thead class="table-light">
          <tr><th>Dimensi</th><th>2024</th></tr>
        </thead>
        <tbody>
          ${urutan.map(idx => {
            const row = dataPerUnit.find(d => d["Index_name"] === idx);
            const val = row && row["Value24"] ? row["Value24"] : "-";
            const colorClass = getColorClass(val);
            return `<tr><td>${idx}</td><td class="${colorClass}">${val}</td></tr>`;
          }).join("")}
        </tbody>
      </table>
    `;
    document.getElementById("tabelUnitKerja").innerHTML = html;
  }
}

document.addEventListener("DOMContentLoaded", async () => {
  await loadAllKomponenData();
  document.getElementById("btnInternal").onclick = function() {
    kelompokAktif = "Internal";
    this.classList.add("active");
    document.getElementById("btnEksternal").classList.remove("active");
    document.getElementById("btnEksper").classList.remove("active");
    tampilkanTabelRadarKomponen();
  };
  document.getElementById("btnEksternal").onclick = function() {
    kelompokAktif = "Eksternal";
    this.classList.add("active");
    document.getElementById("btnInternal").classList.remove("active");
    document.getElementById("btnEksper").classList.remove("active");
    tampilkanTabelRadarKomponen();
  };
  document.getElementById("btnEksper").onclick = function() {
    kelompokAktif = "Eksper";
    this.classList.add("active");
    document.getElementById("btnInternal").classList.remove("active");
    document.getElementById("btnEksternal").classList.remove("active");
    tampilkanTabelRadarKomponen();
  };
  document.getElementById("instansiInput").addEventListener("change", tampilkanTabelRadarKomponen);
  document.getElementById("yearSelect").addEventListener("change", tampilkanTabelRadarKomponen);
  document.getElementById("btnInternal").classList.add("active");
  tampilkanTabelRadarKomponen();
});
</script>

<footer class="text-center small text-muted mt-5 mb-3">v1.0206251421<br>© Tim SPI 2025 KPK RI</footer>
</body>
</html>
