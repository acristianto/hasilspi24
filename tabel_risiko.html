<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Risiko SPI 2024</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background: #f4f6f9; }
    .custom-card {
      background: white;
      border-radius: 18px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.10);
      padding: 1.5rem;
      margin-bottom: 2.5rem;
    }
    .sub-title {
      letter-spacing: 2px;
      font-weight: 800;
      font-size: 1.17rem;
      color: #37517e;
      margin-bottom: 2px;
      margin-top: 20px;
    }
    .group-title {
      font-weight: 700;
      font-size: 1.05rem;
      margin: 25px 0 10px 0;
      color: #22223b;
      border-bottom: 1.5px solid #e6e7ec;
      padding-bottom: 3px;
      letter-spacing: 0.3px;
    }
    .risk-low         { background: #a7f3d0 !important; color: #222 !important; font-weight: bold; }
    .risk-medium      { background: #fde68a !important; color: #222 !important; font-weight: bold; }
    .risk-high        { background: #f87171 !important; color: #222 !important; font-weight: bold; }
    .risk-very-high   { background: #991b1b !important; color: #fff !important; font-weight: bold; }
    .risk-custom-merah{ background: #991b1b !important; color: #fff !important; font-weight: bold; }
    .risk-custom-merah-muda { background: #f87171 !important; color: #222 !important; font-weight: bold; }
    .risk-custom-kuning { background: #fde68a !important; color: #222 !important; font-weight: bold; }
    .risk-custom-hijau { background: #a7f3d0 !important; color: #222 !important; font-weight: bold; }
    .table > :not(:last-child) > :last-child > * { border-bottom-color: #bbb !important; }
    .table td, .table th { vertical-align: middle; font-size: 0.98rem; }
    .instansi-note {
      background: #e9ecef;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 18px;
      font-size: 1rem;
      color: #333;
    }
    .checklist-tahun label {
      margin-right: 16px;
      margin-bottom: 2px;
      font-weight: 500;
    }
    @media (max-width: 900px) {
      .custom-card { padding: 0.8rem; }
      .table th, .table td { font-size: 0.92rem; }
    }
  </style>
</head>
<body>
<div class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <img src="https://elhkpn.kpk.go.id/portal-assets/img/image2.jpeg" style="height:42px;">
    <h3 class="text-center flex-grow-1 mb-0" style="font-size:1.3rem">Dashboard Risiko SPI 2024</h3>
    <img src="https://spi.kpk.go.id/img/logo-spi.d5368d4c.png" style="height:42px;">
  </div>

  <div class="instansi-note">
    <strong>Tabel Risiko dapat digunakan untuk menentukan prioritas fokus tindak lanjut dalam rangka upaya pencegahan korupsi.</strong>
  </div>

  <div class="mb-3">
    <label for="instansiInput" class="form-label">Nama Instansi:</label>
    <input class="form-control" list="instansiList" id="instansiInput" placeholder="Ketik nama instansi...">
    <datalist id="instansiList"></datalist>
  </div>

  <div class="mb-3 checklist-tahun">
    <div class="fw-bold mb-1">Pilih Tahun Risiko yang ingin ditampilkan:</div>
    <label><input type="checkbox" class="tahun-checkbox" value="2021" checked> 2021</label>
    <label><input type="checkbox" class="tahun-checkbox" value="2022" checked> 2022</label>
    <label><input type="checkbox" class="tahun-checkbox" value="2023" checked> 2023</label>
    <label><input type="checkbox" class="tahun-checkbox" value="2024" checked> 2024</label>
  </div>

  <div id="risikoCards"></div>
</div>

<script>
const mappingInternal = [
  { key: "Integritas Pelaksanaan Tugas", label: "Integritas Dalam Pelaksanaan Tugas" },
  { key: "Pengelolaan Anggaran", label: "Pengelolaan Anggaran" },
  { key: "Pengelolaan Pengadaan Barang dan Jasa", label: "Pengelolaan PBJ" },
  { key: "Sumber Daya Manusia", label: "Pengelolaan SDM" },
  { key: "Perdagangan Pengaruh", label: "Perdagangan Pengaruh (Trading in Influence)" },
  { key: "Sosialisasi Antikorupsi", label: "Sosialisasi Antikorupsi" },
  { key: "Transparansi", label: "Transparansi" }
];
const mappingEksternal = [
  { key: "Integritas Pegawai", label: "Integritas Pegawai" },
  { key: "Transparansi dan Keadilan Layanan", label: "Transparansi dan Keadilan Layanan" },
  { key: "Sosialisasi dan Sistem Antikorupsi", label: "Upaya Pencegahan Korupsi" }
];
const mappingEksper = [
  { key: "Integritas Instansi", label: "Integritas Instansi" }
];

const kelompokRisiko = [
  { title: "INTERNAL", groups: mappingInternal },
  { title: "EKSTERNAL", groups: mappingEksternal },
  { title: "EKSPER", groups: mappingEksper }
];

const SPECIAL_DIMENSI = [
  "Sosialisasi Antikorupsi",
  "Transparansi",
  "Upaya Pencegahan Korupsi"
];

// Fungsi cek cell class berdasarkan value & dimensi
function riskCellClass(val, dimensi) {
  // Jika NA, return "" (tidak pewarnaan)
  if (!val || val.trim().toUpperCase() === "NA") return "";
  const v = val.trim().toLowerCase();

  if (SPECIAL_DIMENSI.includes(dimensi)) {
    if (v === "rendah" || v === "di bawah rata-rata") return "risk-custom-merah";
    if (v === "kurang") return "risk-custom-merah-muda";
    if (v === "sedang") return "risk-custom-kuning";
    if (v === "tinggi" || v === "di atas rata-rata") return "risk-custom-hijau";
    return "";
  } else {
    if (v === "rendah") return "risk-low";
    if (v === "sedang") return "risk-medium";
    if (v === "tinggi") return "risk-high";
    if (v === "sangat tinggi") return "risk-very-high";
    // Aturan default, NA dan lainnya = ""
    return "";
  }
}

// Fungsi untuk menampilkan nilai (jika NA tampil blank)
function renderValue(val) {
  if (!val || val.trim().toUpperCase() === "NA") return "";
  return val;
}

// Untuk checklist tahun
function getCheckedTahun() {
  const checkboxes = document.querySelectorAll('.tahun-checkbox');
  let tahun = [];
  checkboxes.forEach(cb => { if (cb.checked) tahun.push(cb.value); });
  return tahun;
}

const tahunColumns = [
  { tahun: "2021", col: "Level_Risiko21" },
  { tahun: "2022", col: "Level_Risiko22" },
  { tahun: "2023", col: "Level_Risiko23" },
  { tahun: "2024", col: "Level_Risiko24" }
];

const RISIKO_CSV_URL = "https://raw.githubusercontent.com/timotiushps/hasilspi24/main/risiko.csv";
let risikoData = [];

function renderRisikoCards(instansi) {
  const tahunSelected = getCheckedTahun();
  const tahunCols = tahunColumns.filter(t => tahunSelected.includes(t.tahun));

  const filtered = risikoData.filter(r => r["data.instansi"] === instansi);

  if (filtered.length === 0) {
    document.getElementById("risikoCards").innerHTML = "<div class='text-center text-muted my-5'>Silakan pilih instansi untuk menampilkan data risiko.</div>";
    return;
  }

  let html = "";
  kelompokRisiko.forEach(kel => {
    let cardContent = "";

    kel.groups.forEach(g => {
      // Data pada CSV berdasarkan dimensi_report (key), nama tampil sesuai label
      const rows = filtered.filter(r => (r["dimensi_report"] || "").trim() === g.key);

      if (rows.length > 0) {
        cardContent += `
          <div class="group-title">${g.label}</div>
          <div class="table-responsive mb-4">
            <table class="table table-bordered table-sm shadow-sm">
              <thead class="table-light">
                <tr>
                  <th>Index Name</th>
                  <th>Keterangan</th>
                  ${tahunCols.map(t => `<th>Level Risiko ${t.tahun}</th>`).join("")}
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => `
                  <tr>
                    <td>${r["Index_name"] ?? "-"}</td>
                    <td>${r["ket_report"] ?? "-"}</td>
                    ${tahunCols.map(t =>
                      `<td class="${riskCellClass(r[t.col], g.label)}">${renderValue(r[t.col])}</td>`
                    ).join("")}
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
      }
    });

    if (cardContent) {
      html += `
        <div class="custom-card mb-4">
          <div class="sub-title">${kel.title}</div>
          ${cardContent}
        </div>
      `;
    }
  });

  document.getElementById("risikoCards").innerHTML = html;
}

fetch(RISIKO_CSV_URL)
  .then(res => res.text())
  .then(csv => {
    Papa.parse(csv, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        risikoData = results.data;
        // Autocomplete dari kolom "data.instansi"
        const instansis = [...new Set(risikoData.map(r => r["data.instansi"]))].filter(Boolean);
        const list = document.getElementById("instansiList");
        list.innerHTML = "";
        instansis.forEach(i => {
          const opt = document.createElement("option");
          opt.value = i;
          list.appendChild(opt);
        });
      }
    });
  });

document.getElementById("instansiInput").addEventListener("input", function() {
  renderRisikoCards(this.value);
});
document.querySelectorAll('.tahun-checkbox').forEach(cb => {
  cb.addEventListener('change', function() {
    renderRisikoCards(document.getElementById("instansiInput").value);
  });
});
</script>

<footer class="text-center small text-muted mt-5 mb-3">v1.07 Risiko SPI 2024<br>Â© Tim SPI 2025 KPK RI</footer>
</body>
</html>
