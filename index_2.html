<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Indeks SPI 2024</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@0.7.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { background-color: #fff; padding-bottom: 4rem; }
    .angka-indeks { font-size: 1.5rem; font-weight: bold; }
    .angka-agregat { font-size: 2rem; font-weight: bold; }
    .hijau { color: green; } .kuning { color: orange; } .merah { color: red; }
    footer { position: fixed; bottom: 0; left: 0; width: 100%; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <img src="https://elhkpn.kpk.go.id/portal-assets/img/image2.jpeg" style="height:50px;">
      <h3 class="text-center flex-grow-1">Dashboard Indeks Hasil SPI 2024</h3>
      <img src="https://spi.kpk.go.id/img/logo-spi.d5368d4c.png" style="height:50px;">
    </div>

    <!-- Instansi & Tahun -->
    <div class="row mb-4">
      <div class="col-md-6 mb-2">
        <label>Nama Instansi:</label>
        <input class="form-control" list="instansiList" id="instansiInput" placeholder="Ketik instansi...">
        <datalist id="instansiList"></datalist>
      </div>
      <div class="col-md-6 mb-2">
        <label>Pilih Tahun:</label>
        <select id="yearSelect" class="form-select">
          <option value="21">2021</option>
          <option value="22">2022</option>
          <option value="23">2023</option>
          <option value="24" selected>2024</option>
        </select>
      </div>
    </div>

    <!-- Summary & Charts utama -->
    <div id="summaryBox" class="text-center mb-4"></div>
    <div class="row mb-4">
      <div class="col-md-6">
        <h6 class="text-center">Indeks Agregat (Sebelum Faktor Koreksi)</h6>
        <canvas id="radarMain"></canvas>
      </div>
      <div class="col-md-6">
        <h6 class="text-center">Faktor Koreksi</h6>
        <canvas id="barFaktor"></canvas>
      </div>
    </div>
    <div class="row mb-4">
      <div class="col-12"><h6 class="text-center">Tren Indeks (2021–2024)</h6><canvas id="lineTren"></canvas></div>
      <div class="col-12"><h6 class="text-center">Tren Faktor Koreksi (2021–2024)</h6><canvas id="lineFaktor"></canvas></div>
    </div>

    <!-- Detail Komponen -->
    <div class="container mt-5 mb-4">
      <h5 class="text-center mb-3">Detail Komponen Indeks</h5>
      <div class="d-flex justify-content-center mb-3">
        <button class="btn btn-outline-primary mx-1" id="btnInternal">Internal</button>
        <button class="btn btn-outline-success mx-1" id="btnEksternal">Eksternal</button>
        <button class="btn btn-outline-warning mx-1" id="btnEksper">Eksper</button>
      </div>
      <div class="row mb-4" id="radarArea">
        <div class="col-md-6 offset-md-3">
          <canvas id="radarDetail" width="350" height="350"></canvas>
        </div>
      </div>
      <div id="tabelDetail"></div>
    </div>
  </div>

  <footer class="text-center small text-muted mt-5 mb-3">
    v1.{{DD}}{{MM}}{{YYYY}}{{HH}}{{mm}}<br>© Tim SPI KPK RI
  </footer>

<script>
// ### UTAMA (ringkasan, tren) tetap dipanggil seperti sebelumnya ###
// ... sertakan semua fungsi updateDashboard(), getValsOverYears(), renderFaktorKoreksiLineChart() dst. ###
// Untuk singkat, anggap script utama sudah ada di sini.

// ### Detail Komponen ###
let dataI, dataE, dataX, radarDetail;
async function loadDetail() {
  const u=["internal","eksternal","eksper"].map(k=>
    fetch(`https://raw.githubusercontent.com/timotiushps/hasilspi24/main/agregat_tracking_${k}.csv`)
      .then(r=>r.text()).then(t=>Papa.parse(t,{header:true,skipEmptyLines:true}).data)
  );
  [dataI,dataE,dataX] = await Promise.all(u);
}

function komponen(k,inst) {
  const arr = k==="Internal"? dataI : k==="Eksternal"? dataE : dataX;
  return arr.filter(r=>r["data.instansi"]===inst && !["Internal","Eksternal","Eksper"].includes(r["Index_name"]));
}

function renderDetail(kel) {
  const inst = document.getElementById("instansiInput").value;
  const th   = document.getElementById("yearSelect").value;
  const kom  = komponen(kel, inst);

  // Tabel
  document.getElementById("tabelDetail").innerHTML = `
    <table class="table table-sm table-bordered">
      <thead class="table-light"><tr>
        <th>Index Name</th><th>2021</th><th>2022</th><th>2023</th><th>2024</th>
      </tr></thead>
      <tbody>
        ${kom.map(r=>`
          <tr>
            <td>${r["Index_name"]}</td>
            <td>${r["Value21"]||"-"}</td>
            <td>${r["Value22"]||"-"}</td>
            <td>${r["Value23"]||"-"}</td>
            <td>${r["Value24"]||"-"}</td>
          </tr>`).join("")}
      </tbody>
    </table>`;

  // Radar
  if(kel==="Eksper") {
    document.getElementById("radarArea").style.display="none";
    return;
  }
  document.getElementById("radarArea").style.display="";
  const labels = kom.map(r=>r["Index_name"]);
  const yrs    = [21,22,23,24], names=["2021","2022","2023","2024"];
  const cols   = ["rgba(0,123,255,0.45)","rgba(40,167,69,0.35)","rgba(255,193,7,0.30)","rgba(220,53,69,0.30)"];
  const bcols  = ["#007bff","#28a745","#ffc107","#dc3545"];
  const ds = yrs.map((y,i)=>({
    label: names[i],
    data: labels.map((_,j)=>parseFloat( kom[j]["Value"+y] )||0),
    backgroundColor: cols[i], borderColor: bcols[i], fill: true
  }));
  if(radarDetail) radarDetail.destroy();
  radarDetail = new Chart(
    document.getElementById("radarDetail"),
    { type:"radar", data:{labels, datasets:ds},
      options:{responsive:true,legend:{display:true,position:"right"},scale:{ticks:{beginAtZero:true,max:100}}}
    }
  );
}

document.addEventListener("DOMContentLoaded", async ()=>{
  await loadDetail();
  ["Internal","Eksternal","Eksper"].forEach(k=>{
    document.getElementById("btn"+k).onclick=()=>{
      renderDetail(k);
      ["Internal","Eksternal","Eksper"].forEach(x=>
        document.getElementById("btn"+x).classList.toggle("active", x===k)
      );
    };
  });
  document.getElementById("instansiInput").addEventListener("change",()=>{
    const active = document.querySelector(".btn.active").id.replace("btn","");
    renderDetail(active);
  });
  document.getElementById("yearSelect").addEventListener("change",()=>{
    const active = document.querySelector(".btn.active").id.replace("btn","");
    renderDetail(active);
  });
  // Default
  document.getElementById("btnInternal").classList.add("active");
  renderDetail("Internal");
});
</script>
</body>
</html>
